<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="author" content="Joao Roccella">
    <title>Consulta da API ViaCEP</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
</head>

<body>
    <main class="container">

        <h1 class="mb-4">Consulta da API ViaCEP</h1>

        <p>Este é um formulário de consulta de endereços funcional utilizando a API da ViaCEP. O código em javascript
            foi atualizado e a página foi estilizada com Bootstrap para oferecer ao usuário uma melhor experiência
            visual.</p>

        <p>Utilize o formulário para consultar um CEP. Teste diferentes situações: consulte um CEP válido que existe,
            depois um CEP válido que não existe, depois um CEP inválido, etc.</p>

        <!-- Inicio do formulario -->
        <form method="get" action=".">

            <div class="row">
                <div class="col-md-3">
                    <div class="form-floating mb-3">
                        <input class="form-control" name="cep" type="text" id="cep" value="" size="10" maxlength="9"
                            onblur="pesquisaCEP(this.value);" placeholder="CEP" autofocus>
                        <label for="cep">CEP</label>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-md-12">
                    <div class="form-floating mb-3">
                        <input class="form-control" name="rua" type="text" id="rua" size="60" placeholder="Logradouro">
                        <label for="rua">Logradouro</label>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-md-5">
                    <div class="form-floating mb-3">
                        <input class="form-control" name="bairro" type="text" id="bairro" size="40"
                            placeholder="Bairro">
                        <label for="bairro">Bairro</label>
                    </div>
                </div>

                <div class="col-md-5">
                    <div class="form-floating mb-3">
                        <input class="form-control" name="cidade" type="text" id="cidade" size="40"
                            placeholder="Cidade">
                        <label for="cidade">Cidade</label>
                    </div>
                </div>

                <div class="col-md-2">
                    <div class="form-floating mb-3">
                        <input class="form-control" name="uf" type="text" id="uf" size="2" placeholder="UF">
                        <label for="uf">UF</label>
                    </div>
                </div>
            </div>

        </form>
    </main>

    <script>

        function limpaFormularioCEP() {
            //Limpa valores do formulário de cep.
            document.getElementById('rua').value = '';
            document.getElementById('bairro').value = '';
            document.getElementById('cidade').value = '';
            document.getElementById('uf').value = '';

            document.querySelector('#rua').removeAttribute('disabled');
            document.querySelector('#bairro').removeAttribute('disabled');
            document.querySelector('#cidade').removeAttribute('disabled');
            document.querySelector('#uf').removeAttribute('disabled');

        }

        function carregaCEP(conteudo) {

            if (!("erro" in conteudo)) {

                //Atualiza os campos com os valores.
                document.getElementById('rua').value = conteudo.logradouro;
                document.getElementById('bairro').value = conteudo.bairro;
                document.getElementById('cidade').value = conteudo.localidade;
                document.getElementById('uf').value = conteudo.uf;

                document.querySelector('#rua').removeAttribute('disabled');
                document.querySelector('#rua').focus();

            } else {

                //CEP não Encontrado.
                limpaFormularioCEP();
                alert('CEP não encontrado.');
            }
        }

        function pesquisaCEP(valor) {

            //Nova variável "cep" somente com dígitos.
            const cep = valor.replace(/\D/g, '');

            //Verifica se campo cep possui valor informado.
            if (cep != "") {

                //Expressão regular para validar o CEP.
                const validacep = /^[0-9]{8}$/;

                //Valida o formato do CEP.
                if (validacep.test(cep)) {

                    document.querySelector('#rua').setAttribute('disabled', '');
                    document.querySelector('#bairro').setAttribute('disabled', '');
                    document.querySelector('#cidade').setAttribute('disabled', '');
                    document.querySelector('#uf').setAttribute('disabled', '');

                    const requisicao = new Request(`https://viacep.com.br/ws/${cep}/json/`, {
                        method: 'GET',
                        headers: {
                            'Content-type': 'application/json',
                        },
                    })

                    fetch(requisicao)
                        .then(resposta => resposta.json())
                        .then(resposta => carregaCEP(resposta));

                } else {

                    //cep é inválido.
                    limpaFormularioCEP();
                    alert('Formato de CEP inválido.');
                }

            } else {

                //cep sem valor, limpa formulário.
                limpaFormularioCEP();
            }
        }

    </script>

    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"
        integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.min.js"
        integrity="sha384-BBtl+eGJRgqQAUMxJ7pMwbEyER4l1g+O15P+16Ep7Q9Q+zqX6gSbd85u4mG4QzX+"
        crossorigin="anonymous"></script>
</body>

</html>